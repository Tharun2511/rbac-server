-- Create Enums
CREATE TYPE user_role_enum AS ENUM ('USER', 'ADMIN', 'MANAGER', 'RESOLVER');
CREATE TYPE ticket_status_enum AS ENUM ('OPEN', 'ASSIGNED', 'RESOLVED', 'VERIFIED', 'CLOSED');
CREATE TYPE ticket_priority_enum AS ENUM ('LOW', 'MEDIUM', 'HIGH', 'CRITICAL');
CREATE TYPE ticket_type_enum AS ENUM ('TICKET', 'BUG', 'FEATURE', 'SUPPORT', 'GENERAL');

-- Users Table
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name TEXT NOT NULL,
    email TEXT UNIQUE NOT NULL,
    "passwordHash" TEXT NOT NULL,
    "refreshToken" TEXT DEFAULT NULL,
    role user_role_enum NOT NULL DEFAULT 'USER',
    "isActive" BOOLEAN DEFAULT FALSE,
    "createdAt" TIMESTAMPTZ DEFAULT NOW(),
    "updatedAt" TIMESTAMPTZ DEFAULT NOW()
);

-- Tickets Table
CREATE TABLE tickets (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    title TEXT NOT NULL,
    description TEXT NOT NULL,
    status ticket_status_enum DEFAULT 'OPEN',
    priority ticket_priority_enum DEFAULT 'LOW',
    type ticket_type_enum DEFAULT 'TICKET',
    "created_by" UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    "resolver_id" UUID REFERENCES users(id) ON DELETE SET NULL,
    "created_at" TIMESTAMPTZ DEFAULT NOW(),
    "updated_at" TIMESTAMPTZ DEFAULT NOW()
);

-- Ticket Comments Table
CREATE TABLE ticket_comments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    "ticketId" UUID NOT NULL REFERENCES tickets(id) ON DELETE CASCADE,
    "userId"   UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

    comment TEXT NOT NULL,

    "createdAt" TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Ticket Activity Table
CREATE TABLE ticket_activity (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    "ticketId" UUID NOT NULL REFERENCES tickets(id) ON DELETE CASCADE,
    "performedBy" UUID NOT NULL REFERENCES users(id) ON DELETE SET NULL,
    type TEXT NOT NULL, -- keeping as text for flexibility (TICKET_CREATED, etc.)
    metadata JSONB,
    "createdAt" TIMESTAMPTZ DEFAULT NOW()
);
